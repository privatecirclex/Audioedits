<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LyricsAI - Client-Side Sync Tool</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            yellow: '#F59E0B',
                            orange: '#F97316',
                            red: '#EF4444',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }

        /* Karaoke Active State Animation */
        .karaoke-line { transition: all 0.3s ease; opacity: 0.5; transform: scale(1); }
        .karaoke-line.active { 
            opacity: 1; 
            transform: scale(1.05);
            background: linear-gradient(to right, #F59E0B, #EF4444);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
        }

        /* Loader Animation */
        .loader-bar {
            background: linear-gradient(90deg, #F59E0B, #F97316, #EF4444);
            background-size: 200% 200%;
            animation: gradientMove 2s ease infinite;
        }
        @keyframes gradientMove { 
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* Fix for scroll areas */
        .scroll-container {
            scrollbar-gutter: stable;
        }
    </style>
</head>
<body class="bg-white text-slate-800 font-sans h-screen flex flex-col overflow-hidden">

    <header class="flex-none h-16 border-b border-slate-100 flex items-center justify-between px-6 bg-white z-10">
        <div class="flex items-center gap-2">
            <i class="fa-solid fa-wave-square text-brand-orange text-xl"></i>
            <h1 class="text-xl font-bold tracking-tight text-slate-900">Lyrics<span class="text-transparent bg-clip-text bg-gradient-to-r from-brand-orange to-brand-red">AI</span></h1>
        </div>
        <button id="exportBtn" class="bg-gradient-to-r from-brand-yellow via-brand-orange to-brand-red text-white px-5 py-2 rounded-lg font-medium shadow-md shadow-orange-100 hover:shadow-lg hover:shadow-orange-200 transition-all transform hover:-translate-y-0.5 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
            <i class="fa-solid fa-download mr-2"></i> Export .LRC
        </button>
    </header>

    <main class="flex-1 flex flex-col relative overflow-hidden">
        
        <div id="uploadView" class="absolute inset-0 z-20 bg-white flex flex-col items-center justify-center p-6 transition-all duration-500">
            <div id="dropZone" class="w-full max-w-2xl border-2 border-dashed border-slate-300 rounded-2xl p-12 text-center hover:border-brand-orange hover:bg-orange-50 transition-colors cursor-pointer group">
                <div class="w-16 h-16 bg-orange-100 text-brand-orange rounded-full flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform pointer-events-none">
                    <i class="fa-solid fa-cloud-upload-alt text-2xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-slate-800 mb-2 pointer-events-none">Upload Audio</h2>
                <p class="text-slate-500 mb-6 pointer-events-none">Drag & drop your song (MP3, WAV) to start AI transcription.</p>
                <input type="file" id="fileInput" class="hidden" accept="audio/*">
                <button type="button" id="selectBtn" class="px-6 py-2 bg-white border border-slate-300 rounded-lg text-slate-700 font-medium hover:border-brand-orange hover:text-brand-orange transition-colors">
                    Select File
                </button>
            </div>

            <div id="progressContainer" class="hidden mt-8 w-full max-w-md">
                <div class="flex justify-between text-sm font-medium text-slate-600 mb-2">
                    <span id="statusText">Initializing AI Model...</span>
                    <span id="percentText">0%</span>
                </div>
                <div class="w-full bg-slate-100 rounded-full h-2.5 overflow-hidden">
                    <div id="progressBar" class="loader-bar h-2.5 rounded-full" style="width: 0%"></div>
                </div>
                <p class="text-xs text-slate-400 mt-4 text-center">First run downloads the model (~80MB). Processing happens entirely on your device.</p>
            </div>
        </div>

        <div id="workspaceView" class="flex-1 flex flex-col hidden opacity-0 transition-opacity duration-500 h-full">
            
            <div class="bg-white border-b border-slate-100 p-4 shadow-sm flex-none z-10">
                <div class="flex items-center justify-center gap-4 mb-4">
                    <button id="playPauseBtn" class="w-12 h-12 rounded-full bg-slate-900 text-white flex items-center justify-center hover:bg-slate-700 transition-colors focus:ring-2 focus:ring-brand-orange focus:ring-offset-2">
                        <i class="fa-solid fa-play"></i>
                    </button>
                    <div class="text-sm font-mono text-slate-500 bg-slate-50 px-3 py-1 rounded border border-slate-100" id="timeDisplay">00:00 / 00:00</div>
                </div>
                <div id="waveform" class="w-full"></div>
            </div>

            <div class="flex justify-center border-b border-slate-100 bg-white">
                <button data-tab="editor" class="tab-btn active px-6 py-3 text-sm font-medium border-b-2 border-brand-orange text-brand-orange transition-all">
                    <i class="fa-solid fa-pen-to-square mr-2"></i> Editor
                </button>
                <button data-tab="preview" class="tab-btn px-6 py-3 text-sm font-medium border-b-2 border-transparent text-slate-500 hover:text-slate-700 transition-all">
                    <i class="fa-solid fa-microphone-lines mr-2"></i> Karaoke Preview
                </button>
            </div>

            <div class="flex-1 relative bg-slate-50 overflow-hidden">
                <div id="editorView" class="absolute inset-0 overflow-y-auto p-4 pb-24 scroll-container">
                    <div id="transcriptList" class="max-w-4xl mx-auto space-y-3">
                        </div>
                </div>

                <div id="previewView" class="absolute inset-0 hidden bg-white flex flex-col items-center p-8 text-center overflow-y-auto scroll-container">
                    <div id="karaokeDisplay" class="space-y-8 max-w-3xl w-full py-20">
                        </div>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.0';
        import WaveSurfer from 'https://unpkg.com/wavesurfer.js@7/dist/wavesurfer.esm.js';
        import RegionsPlugin from 'https://unpkg.com/wavesurfer.js@7/dist/plugins/regions.esm.js';

        // --- Configuration ---
        env.allowLocalModels = false;
        const MODEL_NAME = 'Xenova/whisper-base';
        
        // --- State ---
        let wavesurfer;
        let wsRegions;
        let transcriptData = [];
        let transcriber = null; // Model singleton

        // --- DOM Elements ---
        const els = {
            dropZone: document.getElementById('dropZone'),
            fileInput: document.getElementById('fileInput'),
            selectBtn: document.getElementById('selectBtn'),
            uploadView: document.getElementById('uploadView'),
            workspaceView: document.getElementById('workspaceView'),
            progressContainer: document.getElementById('progressContainer'),
            progressBar: document.getElementById('progressBar'),
            statusText: document.getElementById('statusText'),
            percentText: document.getElementById('percentText'),
            waveform: document.getElementById('waveform'),
            playPauseBtn: document.getElementById('playPauseBtn'),
            timeDisplay: document.getElementById('timeDisplay'),
            transcriptList: document.getElementById('transcriptList'),
            karaokeDisplay: document.getElementById('karaokeDisplay'),
            tabBtns: document.querySelectorAll('.tab-btn'),
            editorView: document.getElementById('editorView'),
            previewView: document.getElementById('previewView'),
            exportBtn: document.getElementById('exportBtn')
        };

        // --- Initialization ---

        // File Selection Logic
        els.selectBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            els.fileInput.click();
        });

        els.dropZone.addEventListener('click', () => els.fileInput.click());
        
        els.dropZone.addEventListener('dragover', (e) => { 
            e.preventDefault(); 
            els.dropZone.classList.add('border-brand-orange', 'bg-orange-50'); 
        });

        els.dropZone.addEventListener('dragleave', () => {
            els.dropZone.classList.remove('border-brand-orange', 'bg-orange-50');
        });

        els.dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            els.dropZone.classList.remove('border-brand-orange', 'bg-orange-50');
            if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        });

        els.fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) handleFile(e.target.files[0]);
        });

        // Tab Navigation
        els.tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                els.tabBtns.forEach(b => {
                    b.classList.remove('border-brand-orange', 'text-brand-orange');
                    b.classList.add('border-transparent', 'text-slate-500');
                });
                btn.classList.add('border-brand-orange', 'text-brand-orange');
                btn.classList.remove('border-transparent', 'text-slate-500');

                if (btn.dataset.tab === 'editor') {
                    els.editorView.classList.remove('hidden');
                    els.previewView.classList.add('hidden');
                } else {
                    els.editorView.classList.add('hidden');
                    els.previewView.classList.remove('hidden');
                    renderPreview();
                }
            });
        });

        els.playPauseBtn.addEventListener('click', () => wavesurfer.playPause());
        els.exportBtn.addEventListener('click', exportLRC);

        // Spacebar shortcut
        window.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && e.target === document.body) {
                e.preventDefault();
                if (wavesurfer) wavesurfer.playPause();
            }
        });

        // --- Logic Functions ---

        function updateProgress(percent, message, isPulse = false) {
            els.progressBar.style.width = `${percent}%`;
            els.percentText.innerText = `${Math.floor(percent)}%`;
            els.statusText.innerText = message;
            isPulse ? els.progressBar.classList.add('animate-pulse') : els.progressBar.classList.remove('animate-pulse');
        }

        async function handleFile(file) {
            // Clean up previous session
            if (wavesurfer) wavesurfer.destroy();
            els.transcriptList.innerHTML = '';
            els.karaokeDisplay.innerHTML = '';
            els.exportBtn.disabled = true;

            els.dropZone.classList.add('hidden');
            els.progressContainer.classList.remove('hidden');
            
            try {
                updateProgress(5, "Loading Waveform...");
                initWaveSurfer(file);

                // Initialize AI Model (Once)
                if (!transcriber) {
                    transcriber = await pipeline('automatic-speech-recognition', MODEL_NAME, {
                        progress_callback: (data) => {
                            if (data.status === 'progress') {
                                const downloadPct = data.progress;
                                const barWidth = 10 + (downloadPct * 0.7);
                                updateProgress(barWidth, `Downloading AI Brain... (${Math.floor(downloadPct)}%)`);
                            }
                            if (data.status === 'done') updateProgress(85, "Model Loaded!");
                        }
                    });
                }

                updateProgress(90, "Reading Audio Data...");
                const audioData = await readAudio(file);

                updateProgress(95, "AI is transcribing... (This may take a minute)", true);
                
                // Allow UI to update before blocking thread
                await new Promise(r => setTimeout(r, 200));

                const output = await transcriber(audioData, {
                    chunk_length_s: 30,
                    stride_length_s: 5,
                    return_timestamps: true
                });

                processTranscription(output);
                
                updateProgress(100, "Processing Complete!");
                els.exportBtn.disabled = false;

                setTimeout(() => {
                    els.uploadView.classList.add('hidden');
                    els.workspaceView.classList.remove('hidden');
                    setTimeout(() => els.workspaceView.classList.remove('opacity-0'), 50);
                }, 600);

            } catch (err) {
                console.error(err);
                alert("Error: " + err.message);
                location.reload();
            }
        }

        function initWaveSurfer(file) {
            wavesurfer = WaveSurfer.create({
                container: els.waveform,
                waveColor: '#fed7aa',
                progressColor: '#ef4444',
                cursorColor: '#f97316',
                barWidth: 2,
                barRadius: 3,
                height: 120,
                normalize: true,
            });

            wsRegions = wavesurfer.registerPlugin(RegionsPlugin.create());

            wavesurfer.loadBlob(file);

            wavesurfer.on('ready', () => {
                els.timeDisplay.innerText = `00:00 / ${formatTime(wavesurfer.getDuration())}`;
            });

            wavesurfer.on('audioprocess', (time) => {
                els.timeDisplay.innerText = `${formatTime(time)} / ${formatTime(wavesurfer.getDuration())}`;
                updatePreviewActiveState(time);
            });

            wavesurfer.on('play', () => els.playPauseBtn.innerHTML = '<i class="fa-solid fa-pause"></i>');
            wavesurfer.on('pause', () => els.playPauseBtn.innerHTML = '<i class="fa-solid fa-play"></i>');

            // Region Sync
            wsRegions.on('region-updated', (region) => {
                const index = transcriptData.findIndex(t => t.regionId === region.id);
                if (index !== -1) {
                    transcriptData[index].start = region.start;
                    transcriptData[index].end = region.end;
                    
                    const sInp = document.getElementById(`start-${index}`);
                    const eInp = document.getElementById(`end-${index}`);
                    if (sInp && Math.abs(parseFloat(sInp.value) - region.start) > 0.05) sInp.value = region.start.toFixed(2);
                    if (eInp && Math.abs(parseFloat(eInp.value) - region.end) > 0.05) eInp.value = region.end.toFixed(2);
                }
            });

            wsRegions.on('region-clicked', (region, e) => {
                e.stopPropagation();
                region.play();
            });
        }

        function processTranscription(output) {
            const chunks = output.chunks || [];
            transcriptData = chunks.map((chunk, i) => {
                let start = chunk.timestamp[0];
                let end = chunk.timestamp[1] || start + 2.5;
                const regionId = `region-${i}`;

                wsRegions.addRegion({
                    id: regionId,
                    start: start,
                    end: end,
                    color: 'rgba(249, 115, 22, 0.15)',
                    drag: true,
                    resize: true
                });

                return { id: i, regionId, start, end, text: chunk.text.trim() };
            });

            renderEditor();
        }

        function renderEditor() {
            els.transcriptList.innerHTML = '';
            transcriptData.forEach((item, index) => {
                const row = document.createElement('div');
                row.className = "flex items-center gap-3 bg-white p-3 rounded-lg border border-slate-200 shadow-sm hover:shadow-md transition-shadow group";
                row.innerHTML = `
                    <div class="flex flex-col gap-1 w-24 flex-none">
                        <input type="number" step="0.1" id="start-${index}" class="text-xs bg-slate-50 border border-slate-200 rounded px-1 py-1 text-slate-600 focus:border-brand-orange outline-none" value="${item.start.toFixed(2)}">
                        <input type="number" step="0.1" id="end-${index}" class="text-xs bg-slate-50 border border-slate-200 rounded px-1 py-1 text-slate-600 focus:border-brand-orange outline-none" value="${item.end.toFixed(2)}">
                    </div>
                    <div class="flex-1">
                        <input type="text" id="text-${index}" class="w-full text-base text-slate-800 font-medium border-b border-transparent focus:border-brand-orange bg-transparent outline-none pb-1" value="${item.text}">
                    </div>
                    <button class="w-8 h-8 rounded-full bg-orange-50 text-brand-orange flex items-center justify-center opacity-0 group-hover:opacity-100 hover:bg-brand-orange hover:text-white transition-all" onclick="window.playSegment('${item.regionId}')">
                        <i class="fa-solid fa-play text-xs"></i>
                    </button>
                `;
                els.transcriptList.appendChild(row);

                // Listeners (Direct update to avoid re-rendering whole list and losing focus)
                const sInp = row.querySelector(`#start-${index}`);
                const eInp = row.querySelector(`#end-${index}`);
                const tInp = row.querySelector(`#text-${index}`);

                const updateRegion = () => {
                    const s = parseFloat(sInp.value);
                    const e = parseFloat(eInp.value);
                    transcriptData[index].start = s;
                    transcriptData[index].end = e;
                    const reg = wsRegions.getRegions().find(r => r.id === item.regionId);
                    if (reg) reg.setOptions({ start: s, end: e });
                };

                sInp.onchange = updateRegion;
                eInp.onchange = updateRegion;
                tInp.oninput = (e) => {
                    transcriptData[index].text = e.target.value;
                    const prev = document.getElementById(`karaoke-${index}`);
                    if (prev) prev.innerText = e.target.value;
                };
            });
        }

        function renderPreview() {
            els.karaokeDisplay.innerHTML = '';
            transcriptData.forEach((item, index) => {
                const p = document.createElement('p');
                p.className = `karaoke-line text-2xl md:text-4xl text-slate-400 font-semibold cursor-pointer py-4 px-4 rounded-xl hover:bg-slate-50`;
                p.id = `karaoke-${index}`;
                p.innerText = item.text;
                p.onclick = () => {
                    wavesurfer.setTime(item.start);
                    wavesurfer.play();
                };
                els.karaokeDisplay.appendChild(p);
            });
        }

        function updatePreviewActiveState(time) {
            if (els.previewView.classList.contains('hidden')) return;
            transcriptData.forEach((item, index) => {
                const el = document.getElementById(`karaoke-${index}`);
                if (!el) return;
                if (time >= item.start && time <= item.end) {
                    if (!el.classList.contains('active')) {
                        el.classList.add('active');
                        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                } else {
                    el.classList.remove('active');
                }
            });
        }

        async function readAudio(file) {
            const buffer = await file.arrayBuffer();
            const ctx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });
            const decoded = await ctx.decodeAudioData(buffer);
            const audio = decoded.getChannelData(0);
            await ctx.close();
            return audio;
        }

        function formatTime(s) {
            const m = Math.floor(s / 60);
            const sec = Math.floor(s % 60);
            return `${m.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
        }

        function exportLRC() {
            let content = '';
            transcriptData.forEach(line => {
                const m = Math.floor(line.start / 60).toString().padStart(2, '0');
                const s = Math.floor(line.start % 60).toString().padStart(2, '0');
                const ms = Math.floor((line.start % 1) * 100).toString().padStart(2, '0');
                content += `[${m}:${s}.${ms}]${line.text}\n`;
            });
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `lyrics.lrc`;
            a.click();
            URL.revokeObjectURL(url);
        }

        window.playSegment = (id) => {
            const r = wsRegions.getRegions().find(reg => reg.id === id);
            if (r) r.play();
        };
    </script>
</body>
</html>
